version: 2.1
orbs:
  aws-s3: circleci/aws-s3@3.0.0
workflows:
 version: 2
 test:
   jobs:
     - build:
        context: TEST
        bucket: 's3://test.go.eco/'
        bucket-fr: 's3://fr.test.go.eco/'
        filters:
          branches:
            only: master
 production:
   jobs:
     - build:
        context: PROD
        bucket: 's3://www.go.eco/'
        bucket-fr: 's3://fr.go.eco/'
        filters:
          branches:
            only: production
jobs:
  build:
    parameters:
      bucket:
        type: string
      bucket-fr:
        type: string
    docker:
    # Image tags available here: https://circleci.com/docs/2.0/docker-image-tags.json
    - image: $NODE_IMAGE
    steps:
    - checkout

    # Build
    - run: sudo apt-get install nasm
    - run: npm install
    - run: npm run build
    - run: SITE_LANG=fr npm run build

    # Deployment
    - aws-s3/sync:
        # arguments: --acl public-read --cache-control "max-age=86400"
        from: public
        to: << parameters.bucket >>

    - aws-s3/sync:
        # arguments: --acl public-read --cache-control "max-age=86400"
        from: public
        to: << parameters.bucket-fr >>
