version: 2.1
orbs:
  aws-s3: circleci/aws-s3@3.1.1
workflows:
 version: 2
 test:
   jobs:
     - build:
        context: TEST
        bucket: 's3://test.go.eco/'
        bucket-de: 's3://de.test.go.eco/'
        bucket-fr: 's3://fr.test.go.eco/'
        filters:
          branches:
            only: master
 production:
   jobs:
     - build:
        context: PROD
        bucket: 's3://www.go.eco/'
        bucket-de: 's3://de.go.eco/'
        bucket-fr: 's3://fr.go.eco/'
        filters:
          branches:
            only: production
jobs:
  build:
    parameters:
      bucket:
        type: string
      bucket-de:
        type: string
      bucket-fr:
        type: string
    docker:
    # https://hub.docker.com/r/cimg/node
    - image: cimg/node:lts
    steps:
    - checkout

    # Build
    - run: sudo apt update
    - run: sudo apt-get install nasm
    - run: npm ci
    - run: npm run build
    - run: SITE_LANG=de npm run build
    - run: SITE_LANG=fr npm run build
    - run: npm run minify

    # Deployment
    - aws-s3/sync:
        arguments:
          --exclude "*.webp"
        from: public
        to: << parameters.bucket >>

    - aws-s3/sync:
        arguments:
          --include "*.webp"
          --content-type image/webp
        from: public
        to: << parameters.bucket >>

    - aws-s3/sync:
        from: public-de
        to: << parameters.bucket-de >>

    - aws-s3/sync:
        from: public-fr
        to: << parameters.bucket-fr >>
